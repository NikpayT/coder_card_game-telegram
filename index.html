<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Code Collector Game</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="game-container">
        <div class="header-info">
            <div class="header-left">
                <span id="experienceDisplay">üåü –û–ø—ã—Ç: 0</span>
                <span id="levelDisplay">‚¨ÜÔ∏è –£—Ä–æ–≤–µ–Ω—å: 1 (0/100 XP)</span>
                <div class="progress-bar-container">
                    <div id="levelProgressBar" class="progress-bar"></div>
                </div>
            </div>
            <div class="header-right">
                <span id="energyDisplay">‚ö°Ô∏è –≠–Ω–µ—Ä–≥–∏—è: 10/10</span>
            </div>
        </div>

        <p class="message" id="gameMessage">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É "–°–±–æ—Ä—â–∏–∫ SQL-—Ñ—É–Ω–∫—Ü–∏–π"! üöÄ</p>

        <div class="buttons-container" id="mainButtons">
            <button id="collectButton">–ù–∞–π—Ç–∏ SQL-—Ñ—É–Ω–∫—Ü–∏—é üîç (1 ‚ö°Ô∏è)</button>
            <button id="viewCollectionButton" class="secondary-button">–ú–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è üéí</button>
            <button id="shopButton" class="secondary-button">–ú–∞–≥–∞–∑–∏–Ω üí∞</button>
            <button id="dailyBonusButton" class="secondary-button">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å üéÅ</button>
            <button id="achievementsButton" class="secondary-button">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è üèÜ</button>
            <button id="statsButton" class="secondary-button">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ üìà</button>
            <button id="projectBoardButton" class="secondary-button">–î–æ—Å–∫–∞ –ü—Ä–æ–µ–∫—Ç–æ–≤ üìã</button>
            <button id="boostersButton" class="secondary-button">–ë—É—Å—Ç–µ—Ä—ã üöÄ</button>
            <button id="marketButton" class="secondary-button">–†—ã–Ω–æ–∫ üíé</button>
            <button id="historyButton" class="secondary-button">–ò—Å—Ç–æ—Ä–∏—è üìú</button>
            <button id="createButton" class="secondary-button">–°–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å üõ†Ô∏è</button>
        </div>

        <div id="collectionDisplay" class="panel" style="display: none;">
            <h3 id="collectionHeader">–ú–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è SQL: (0/55)</h3>
            <div id="collectionList" class="list-grid">
                <p>–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç...</p>
            </div>
            <button id="backFromCollection" class="secondary-button" style="margin-top: 20px;">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="createPanel" class="panel" style="display: none;">
            <h3>–°–æ–∑–¥–∞–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–∞:</h3>
            <div id="availableParts">
                <p>–ó–¥–µ—Å—å –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤! (–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)</p>
            </div>
            <button id="backFromCreate" class="secondary-button" style="margin-top: 20px;">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="shopPanel" class="panel" style="display: none;">
            <h3>–ú–∞–≥–∞–∑–∏–Ω SQL-—Ñ—É–Ω–∫—Ü–∏–π:</h3>
            <div id="buyableItemsList" class="list-grid">
                <p>–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–±—Ä–∞–Ω—ã!</p>
            </div>
            <button id="backFromShop" class="secondary-button" style="margin-top: 20px;">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="marketPanel" class="panel" style="display: none;">
            <h3>–†—ã–Ω–æ–∫ –†–µ–¥–∫–∏—Ö –§—É–Ω–∫—Ü–∏–π:</h3>
            <p style="font-size: 0.9em; color: var(--light-text-color);">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –∫—É–ø–∏—Ç—å —Ä–µ–¥–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –æ–±—ã—á–Ω—ã–º –ø–æ–∏—Å–∫–æ–º.</p>
            <div id="marketItemsList" class="list-grid">
                <p>–ù–∞ —Ä—ã–Ω–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–¥–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π.</p>
            </div>
            <button id="backFromMarket" class="secondary-button" style="margin-top: 20px;">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="dailyBonusPanel" class="panel" style="display: none;">
            <h3>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å! üéÅ</h3>
            <p id="dailyBonusMessage" style="font-size: 1em; margin-bottom: 15px;">–ó–∞–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –±–æ–Ω—É—Å!</p>
            <button id="claimDailyBonusButton">–ó–∞–±—Ä–∞—Ç—å –±–æ–Ω—É—Å (5 üåü)</button>
            <button id="backFromDailyBonus" class="secondary-button" style="margin-top: 10px;">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="achievementsPanel" class="panel" style="display: none;">
            <h3>–í–∞—à–∏ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è üèÜ</h3>
            <div id="achievementsList">
                </div>
            <button id="backFromAchievements" class="secondary-button" style="margin-top: 20px;">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="statsPanel" class="panel" style="display: none;">
            <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ üìà</h3>
            <p>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –Ω–∞–π–¥–µ–Ω–æ: <strong id="statsUniqueCount">0</strong></p>
            <p>–í—Å–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–π (–≤–∫–ª—é—á–∞—è –¥—É–±–ª–∏–∫–∞—Ç—ã): <strong id="statsTotalCount">0</strong></p>
            <p>–û–ø—ã—Ç–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <strong id="statsExperienceEarned">0</strong></p>
            <p>–§—É–Ω–∫—Ü–∏–π –ø—Ä–æ–¥–∞–Ω–æ: <strong id="statsPartsSold">0</strong></p>
            <p>–§—É–Ω–∫—Ü–∏–π –∫—É–ø–ª–µ–Ω–æ: <strong id="statsPartsBought">0</strong></p>
            <button id="backFromStats" class="secondary-button" style="margin-top: 20px;">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="projectPanel" class="panel" style="display: none;">
            <h3>–î–æ—Å–∫–∞ –ü—Ä–æ–µ–∫—Ç–æ–≤ üìã</h3>
            <p style="font-size: 0.9em; color: var(--light-text-color); margin-bottom: 20px;">–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –ø—Ä–æ–µ–∫—Ç—ã, —Å–æ–±–∏—Ä–∞—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ SQL-—Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –±–æ–ª—å—à–∏–µ –Ω–∞–≥—Ä–∞–¥—ã!</p>
            <div id="projectList">
                <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.</p>
            </div>
            <button id="backFromProjectBoard" class="secondary-button" style="margin-top: 20px;">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="boostersPanel" class="panel" style="display: none;">
            <h3>–ë—É—Å—Ç–µ—Ä—ã –∏ –£–ª—É—á—à–µ–Ω–∏—è üöÄ</h3>
            <p style="font-size: 0.9em; color: var(--light-text-color); margin-bottom: 20px;">–£–ª—É—á—à–∏—Ç–µ —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å! (–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±—É—Å—Ç–µ—Ä–æ–≤ 5 –º–∏–Ω—É—Ç)</p>
            <div id="boosterList">
                </div>
            <button id="backFromBoosters" class="secondary-button" style="margin-top: 20px;">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="historyPanel" class="panel" style="display: none;">
            <h3>–ò—Å—Ç–æ—Ä–∏—è –î–µ–π—Å—Ç–≤–∏–π üìú</h3>
            <div id="historyLog">
                <p>–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø—É—Å—Ç–∞.</p>
            </div>
            <button id="backFromHistory" class="secondary-button" style="margin-top: 20px;">–ù–∞–∑–∞–¥</button>
        </div>


        <button id="resetGameButton" class="danger-button" style="margin-top: 30px;">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ (—É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ) üí•</button>
    </div>

    <div id="partDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closePartDetailModal">&times;</span>
            <h4 id="modalPartName">–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏</h4>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <span id="modalPartDescription"></span></p>
            <p><strong>–¢–∏–ø:</strong> <span id="modalPartType"></span></p>
            <p><strong>–ü—Ä–∏–º–µ—Ä:</strong></p>
            <pre><code id="modalPartExample"></code></pre>
            <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏:</strong> <span id="modalPartCount"></span></p>
            <div class="modal-buttons">
                 <button id="modalSellButton" class="item-action-button sell-button" style="display:none;">–ü—Ä–æ–¥–∞—Ç—å (1 üåü)</button>
            </div>
        </div>
    </div>

    <div class="version-info">
        –í–µ—Ä—Å–∏—è: <span id="gameVersion">0.6.2</span>
    </div>

    <script src="game_data.js"></script>

    <script>
        // --- –ò–≥—Ä–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
        let gameData = {
            message: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!",
            collection: [], // [{id: 'sql_select', count: 1}]
            experience: 0,
            level: 1,
            xpToNextLevel: 100,
            currentXp: 0, // –û–ø—ã—Ç –Ω–∞ —Ç–µ–∫—É—â–µ–º —É—Ä–æ–≤–Ω–µ
            totalXpEarned: 0, // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –æ–ø—ã—Ç–∞ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è
            partsSold: 0,
            partsBought: 0,
            lastDailyBonusClaim: 0, // Timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞
            energy: 10,
            maxEnergy: 10,
            energyRecoveryRate: 1, // 1 —ç–Ω–µ—Ä–≥–∏—è –≤ 1 –º–∏–Ω—É—Ç—É
            lastEnergyRecovery: Date.now(),
            activeBoosters: [], // [{id: 'xp_boost', endsAt: timestamp, effect: {type: 'xp_multiplier', value: 2}}]
            history: [], // [{timestamp: Date.now(), message: "–ù–∞–π–¥–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è X"}]
            achievements: { // –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
                collect_5_unique: { completed: false, reward: 10, name: '–ü–µ—Ä–≤–æ–æ—Ç–∫—Ä—ã–≤–∞—Ç–µ–ª—å', description: '–°–æ–±—Ä–∞—Ç—å 5 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö SQL-—Ñ—É–Ω–∫—Ü–∏–π' },
                collect_10_unique: { completed: false, reward: 20, name: '–Æ–Ω—ã–π –ë–∞–∑–∏—Å—Ç', description: '–°–æ–±—Ä–∞—Ç—å 10 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö SQL-—Ñ—É–Ω–∫—Ü–∏–π' },
                collect_20_unique: { completed: false, reward: 40, name: '–ú–∞—Å—Ç–µ—Ä –ó–∞–ø—Ä–æ—Å–æ–≤', description: '–°–æ–±—Ä–∞—Ç—å 20 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö SQL-—Ñ—É–Ω–∫—Ü–∏–π' },
                collect_all_unique: { completed: false, reward: 100, name: '–í–µ–ª–∏–∫–∏–π –°–±–æ—Ä—â–∏–∫', description: '–°–æ–±—Ä–∞—Ç—å –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ SQL-—Ñ—É–Ω–∫—Ü–∏–∏' },
                earn_50_xp: { completed: false, reward: 15, name: '–û–ø—ã—Ç–Ω—ã–π –ö–æ–¥–µ—Ä', description: '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å 50 –æ–ø—ã—Ç–∞' },
                earn_200_xp: { completed: false, reward: 50, name: '–ì—É—Ä—É SQL', description: '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å 200 –æ–ø—ã—Ç–∞' },
                sell_5_parts: { completed: false, reward: 10, name: '–¢–æ—Ä–≥–æ–≤–µ—Ü –î–∞–Ω–Ω—ã–º–∏', description: '–ü—Ä–æ–¥–∞—Ç—å 5 SQL-—Ñ—É–Ω–∫—Ü–∏–π' },
                buy_5_parts: { completed: false, reward: 10, name: '–û–ø—ã—Ç–Ω—ã–π –ü–æ–∫—É–ø–∞—Ç–µ–ª—å', description: '–ö—É–ø–∏—Ç—å 5 SQL-—Ñ—É–Ω–∫—Ü–∏–π' },
                complete_1_project: { completed: false, reward: 25, name: '–ü–µ—Ä–≤—ã–π –ü—Ä–æ–µ–∫—Ç', description: '–ó–∞–≤–µ—Ä—à–∏—Ç—å 1 –ø—Ä–æ–µ–∫—Ç' },
                complete_3_projects: { completed: false, reward: 50, name: '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ë–∞–∑ –î–∞–Ω–Ω—ã—Ö', description: '–ó–∞–≤–µ—Ä—à–∏—Ç—å 3 –ø—Ä–æ–µ–∫—Ç–∞' },
            },
            projects: [ // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
                { id: 'proj_basic_select', name: '–ë–∞–∑–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö', description: '–ò–∑–≤–ª–µ—á—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Customers.', requirements: ['sql_select', 'sql_from'], completed: false, reward_xp: 20 },
                { id: 'proj_filtered_select', name: '–í—ã–±–æ—Ä–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º', description: '–ù–∞–π—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–æ—Ä–æ–∂–µ 50.', requirements: ['sql_select', 'sql_from', 'sql_where'], completed: false, reward_xp: 35 },
                { id: 'proj_insert_data', name: '–í—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏', description: '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—É.', requirements: ['sql_insert_into', 'sql_values'], completed: false, reward_xp: 25 },
                { id: 'proj_update_record', name: '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏', description: '–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏.', requirements: ['sql_update', 'sql_set', 'sql_where'], completed: false, reward_xp: 30 },
                { id: 'proj_delete_record', name: '–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏', description: '–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã.', requirements: ['sql_delete_from', 'sql_where'], completed: false, reward_xp: 20 },
                { id: 'proj_table_join', name: '–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü', description: '–°–æ–µ–¥–∏–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Customers –∏ Orders.', requirements: ['sql_select', 'sql_from', 'sql_join'], completed: false, reward_xp: 50 },
                { id: 'proj_create_simple_table', name: '–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–π —Ç–∞–±–ª–∏—Ü—ã', description: '–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å ID –∏ –∏–º–µ–Ω–µ–º.', requirements: ['sql_create_table', 'sql_int', 'sql_varchar'], completed: false, reward_xp: 40 },
                { id: 'proj_count_records', name: '–ü–æ–¥—Å—á–µ—Ç –∑–∞–ø–∏—Å–µ–π', description: '–ü–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ.', requirements: ['sql_select', 'sql_count', 'sql_from'], completed: false, reward_xp: 20 },
                { id: 'proj_aggregate_data', name: '–ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö', description: '–í—ã—á–∏—Å–ª–∏—Ç—å —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.', requirements: ['sql_select', 'sql_avg', 'sql_group_by'], completed: false, reward_xp: 45 }
            ],
            currentView: 'main' // 'main', 'collection', 'create', 'shop', 'daily_bonus', 'achievements', 'stats', 'market', 'boosters', 'projects', 'history'
        };

        // --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–≥—Ä—ã ---
        const PART_PRICE = 1; // –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏/–ø—Ä–æ–¥–∞–∂–∏ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        const XP_PER_LEVEL_BASE = 100;
        const XP_PER_LEVEL_MULTIPLIER = 1.2;
        const DAILY_BONUS_AMOUNT = 5;
        const DAILY_BONUS_COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
        const ENERGY_CONSUMPTION_PER_FIND = 1;
        const ENERGY_RECOVERY_INTERVAL_MS = 60 * 1000; // 1 –º–∏–Ω—É—Ç–∞

        // –¢–∏–ø—ã —Ä–µ–¥–∫–æ—Å—Ç–∏ (–¥–ª—è —Ä—ã–Ω–∫–∞ –∏ –±—É—Å—Ç–µ—Ä–æ–≤)
        const RARITIES = {
            common: { chance: 0.5, price: 1, name: '–û–±—ã—á–Ω–∞—è' },
            uncommon: { chance: 0.3, price: 3, name: '–ù–µ–æ–±—ã—á–Ω–∞—è' },
            rare: { chance: 0.15, price: 5, name: '–†–µ–¥–∫–∞—è' },
            epic: { chance: 0.04, price: 10, name: '–≠–ø–∏—á–µ—Å–∫–∞—è' },
            legendary: { chance: 0.01, price: 20, name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è' }
        };

        // –ë—É—Å—Ç–µ—Ä—ã
        const BOOSTERS = [
            { id: 'xp_boost', name: '–ë—É—Å—Ç–µ—Ä –æ–ø—ã—Ç–∞ (x2)', description: '–£–¥–≤–æ–µ–Ω–Ω—ã–π –æ–ø—ã—Ç –∑–∞ –Ω–∞—Ö–æ–¥–∫–∏ –Ω–∞ 5 –º–∏–Ω—É—Ç.', cost: 5, duration: 5 * 60 * 1000, effect: { type: 'xp_multiplier', value: 2 } },
            { id: 'energy_boost', name: '–ë—É—Å—Ç–µ—Ä —ç–Ω–µ—Ä–≥–∏–∏', description: '–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ 5 —ç–Ω–µ—Ä–≥–∏–∏.', cost: 3, effect: { type: 'energy_refill', value: 5 } },
            { id: 'find_chance_boost', name: '–ë—É—Å—Ç–µ—Ä —É–¥–∞—á–∏ (+10% —Ä–µ–¥–∫–∏—Ö)', description: '–ü–æ–≤—ã—à–∞–µ—Ç —à–∞–Ω—Å –Ω–∞–π—Ç–∏ —Ä–µ–¥–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ 10% –Ω–∞ 5 –º–∏–Ω—É—Ç.', cost: 7, duration: 5 * 60 * 1000, effect: { type: 'rare_chance', value: 0.1 } }
        ];


        // --- DOM-—ç–ª–µ–º–µ–Ω—Ç—ã (–∫–µ—à–∏—Ä—É–µ–º –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏) ---
        const gameMessageElement = document.getElementById('gameMessage');
        const experienceDisplay = document.getElementById('experienceDisplay');
        const levelDisplay = document.getElementById('levelDisplay');
        const levelProgressBar = document.getElementById('levelProgressBar');
        const energyDisplay = document.getElementById('energyDisplay');
        const mainButtonsContainer = document.getElementById('mainButtons');

        // –ö–Ω–æ–ø–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
        const collectButton = document.getElementById('collectButton');
        const viewCollectionButton = document.getElementById('viewCollectionButton');
        const createButton = document.getElementById('createButton');
        const shopButton = document.getElementById('shopButton');
        const dailyBonusButton = document.getElementById('dailyBonusButton');
        const achievementsButton = document.getElementById('achievementsButton');
        const statsButton = document.getElementById('statsButton');
        const projectBoardButton = document.getElementById('projectBoardButton');
        const boostersButton = document.getElementById('boostersButton');
        const marketButton = document.getElementById('marketButton');
        const historyButton = document.getElementById('historyButton');

        // –ü–∞–Ω–µ–ª–∏
        const collectionDisplay = document.getElementById('collectionDisplay');
        const collectionHeader = document.getElementById('collectionHeader');
        const collectionList = document.getElementById('collectionList');
        const backFromCollectionButton = document.getElementById('backFromCollection');

        const createPanel = document.getElementById('createPanel');
        const backFromCreateButton = document.getElementById('backFromCreate');

        const shopPanel = document.getElementById('shopPanel');
        const buyableItemsList = document.getElementById('buyableItemsList');
        const backFromShopButton = document.getElementById('backFromShop');

        const marketPanel = document.getElementById('marketPanel');
        const marketItemsList = document.getElementById('marketItemsList');
        const backFromMarketButton = document.getElementById('backFromMarket');

        const dailyBonusPanel = document.getElementById('dailyBonusPanel');
        const dailyBonusMessage = document.getElementById('dailyBonusMessage');
        const claimDailyBonusButton = document.getElementById('claimDailyBonusButton');
        const backFromDailyBonusButton = document.getElementById('backFromDailyBonus');

        const achievementsPanel = document.getElementById('achievementsPanel');
        const achievementsList = document.getElementById('achievementsList');
        const backFromAchievementsButton = document.getElementById('backFromAchievements');

        const statsPanel = document.getElementById('statsPanel');
        const statsUniqueCount = document.getElementById('statsUniqueCount');
        const statsTotalCount = document.getElementById('statsTotalCount');
        const statsExperienceEarned = document.getElementById('statsExperienceEarned');
        const statsPartsSold = document.getElementById('statsPartsSold');
        const statsPartsBought = document.getElementById('statsPartsBought');
        const backFromStatsButton = document.getElementById('backFromStats');

        const projectPanel = document.getElementById('projectPanel');
        const projectList = document.getElementById('projectList');
        const backFromProjectBoardButton = document.getElementById('backFromProjectBoard');

        const boostersPanel = document.getElementById('boostersPanel');
        const boosterList = document.getElementById('boosterList');
        const backFromBoostersButton = document.getElementById('backFromBoosters');

        const historyPanel = document.getElementById('historyPanel');
        const historyLog = document.getElementById('historyLog');
        const backFromHistoryButton = document.getElementById('backFromHistory');

        const resetGameButton = document.getElementById('resetGameButton');

        // Modal elements
        const partDetailModal = document.getElementById('partDetailModal');
        const closePartDetailModal = document.getElementById('closePartDetailModal');
        const modalPartName = document.getElementById('modalPartName');
        const modalPartDescription = document.getElementById('modalPartDescription');
        const modalPartType = document.getElementById('modalPartType');
        const modalPartExample = document.getElementById('modalPartExample');
        const modalPartCount = document.getElementById('modalPartCount');
        const modalSellButton = document.getElementById('modalSellButton');


        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App SDK ---
        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            console.log('Telegram WebApp initialized.');
        } else {
            console.warn('Telegram WebApp script not loaded or not in Telegram environment. Running in standalone mode.');
        }

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ ---
        function updateUI() {
            // –û–±—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º textContent –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
            gameMessageElement.textContent = gameData.message;
            experienceDisplay.textContent = `üåü –û–ø—ã—Ç: ${gameData.experience}`;
            levelDisplay.textContent = `‚¨ÜÔ∏è –£—Ä–æ–≤–µ–Ω—å: ${gameData.level} (${gameData.currentXp}/${gameData.xpToNextLevel} XP)`;
            const progressPercentage = (gameData.currentXp / gameData.xpToNextLevel) * 100;
            levelProgressBar.style.width = `${progressPercentage}%`;

            // –≠–Ω–µ—Ä–≥–∏—è
            updateEnergy(); // –û–±–Ω–æ–≤–ª—è–µ–º —ç–Ω–µ—Ä–≥–∏—é –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            energyDisplay.textContent = `‚ö°Ô∏è –≠–Ω–µ—Ä–≥–∏—è: ${gameData.energy}/${gameData.maxEnergy}`;

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–∞–Ω–µ–ª–∏
            const allPanels = [
                mainButtonsContainer, collectionDisplay, createPanel, shopPanel,
                dailyBonusPanel, achievementsPanel, statsPanel, projectPanel,
                boostersPanel, historyPanel, marketPanel
            ];
            allPanels.forEach(panel => panel.style.display = 'none');
            resetGameButton.style.display = 'block'; // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –ø–∞–Ω–µ–ª—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–∞
            switch (gameData.currentView) {
                case 'main':
                    mainButtonsContainer.style.display = 'grid';
                    checkDailyBonusAvailability();
                    break;
                case 'collection':
                    collectionDisplay.style.display = 'block';
                    renderCollection();
                    break;
                case 'create':
                    createPanel.style.display = 'block';
                    // renderCreatePanel(); // –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞
                    break;
                case 'shop':
                    shopPanel.style.display = 'block';
                    renderShopItems();
                    break;
                case 'market':
                    marketPanel.style.display = 'block';
                    renderMarketItems();
                    break;
                case 'daily_bonus':
                    dailyBonusPanel.style.display = 'block';
                    checkDailyBonusAvailability();
                    break;
                case 'achievements':
                    achievementsPanel.style.display = 'block';
                    renderAchievements();
                    break;
                case 'stats':
                    statsPanel.style.display = 'block';
                    renderStats();
                    break;
                case 'projects':
                    projectPanel.style.display = 'block';
                    renderProjects();
                    break;
                case 'boosters':
                    boostersPanel.style.display = 'block';
                    renderBoosters();
                    break;
                case 'history':
                    historyPanel.style.display = 'block';
                    renderHistory();
                    break;
            }

            // –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞
            collectButton.disabled = gameData.energy < ENERGY_CONSUMPTION_PER_FIND;
        }

        // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–∞–Ω–µ–ª–µ–π ---
        function renderCollection() {
            const uniquePartsCount = gameData.collection.length;
            const totalPartsCount = ALL_CODE_PARTS.length;
            collectionHeader.textContent = `–ú–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è SQL: (${uniquePartsCount}/${totalPartsCount})`;

            if (gameData.collection.length === 0) {
                collectionList.innerHTML = '<p style="text-align: center; width: 100%; color: var(--light-text-color);">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç...</p>';
            } else {
                collectionList.innerHTML = '';
                const sortedCollection = [...gameData.collection].sort((a, b) => a.name.localeCompare(b.name));

                sortedCollection.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div class="list-item-main">
                            <span class="list-item-name">${item.emoji || '‚ùì'} ${item.name}</span>
                            <span class="list-item-description">–í –Ω–∞–ª–∏—á–∏–∏: x${item.count}</span>
                        </div>
                        <button class="item-action-button sell-button">–ü—Ä–æ–¥–∞—Ç—å (1 üåü)</button>
                    `;
                    div.querySelector('.list-item-main').onclick = () => showPartDetails(item.id, 'collection');
                    const sellBtn = div.querySelector('.sell-button');
                    sellBtn.onclick = (event) => {
                         event.stopPropagation(); // Prevent modal from opening
                         sellPart(item.id);
                    };
                    collectionList.appendChild(div);
                });
            }
        }

        function showPartDetails(partId, sourcePanel) {
            const part = ALL_CODE_PARTS.find(p => p.id === partId);
            const collectedPart = gameData.collection.find(item => item.id === partId);

            if (part) {
                modalPartName.textContent = `${part.emoji || '‚ùì'} ${part.name}`; // Use textContent for name
                modalPartDescription.textContent = part.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.';
                modalPartType.textContent = part.type || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                modalPartExample.textContent = part.example || '–ü—Ä–∏–º–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.';
                modalPartCount.textContent = collectedPart ? collectedPart.count : 0;

                // Set up sell button listener directly without cloning
                modalSellButton.onclick = null; // Clear previous listener
                if (sourcePanel === 'collection' && collectedPart && collectedPart.count > 0) {
                    modalSellButton.style.display = 'block';
                    modalSellButton.onclick = () => {
                        sellPart(part.id);
                        // After selling, check if count is 0, if so, close modal or update count
                        const updatedCollectedPart = gameData.collection.find(item => item.id === part.id);
                        if (!updatedCollectedPart || updatedCollectedPart.count === 0) {
                            partDetailModal.style.display = 'none'; // Close modal if last one sold
                        } else {
                            modalPartCount.textContent = updatedCollectedPart.count; // Update count in modal
                        }
                        updateUI(); // Refresh UI for collection list
                    };
                } else {
                    modalSellButton.style.display = 'none';
                }

                partDetailModal.style.display = 'flex'; // Use flex to center
            } else {
                gameData.message = "–û—à–∏–±–∫–∞: –î–µ—Ç–∞–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
                updateUI();
            }
        }

        closePartDetailModal.onclick = () => {
            partDetailModal.style.display = 'none';
        };

        window.onclick = (event) => {
            if (event.target === partDetailModal) {
                partDetailModal.style.display = 'none';
            }
        };


        function renderShopItems() {
            const buyableParts = ALL_CODE_PARTS.filter(part => {
                // –¢–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å–æ–≤—Å–µ–º
                return !gameData.collection.some(item => item.id === part.id);
            });

            if (buyableParts.length === 0) {
                buyableItemsList.innerHTML = '<p style="text-align: center; width: 100%; color: var(--light-text-color);">–í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–±—Ä–∞–Ω—ã! üèÜ</p>';
            } else {
                buyableItemsList.innerHTML = '';
                const sortedBuyableParts = [...buyableParts].sort((a, b) => a.name.localeCompare(b.name));

                sortedBuyableParts.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div class="list-item-main">
                            <span class="list-item-name">${item.emoji || '‚ùì'} ${item.name}</span>
                            <span class="list-item-description">–¢–∏–ø: ${item.type || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
                        </div>
                        <button class="item-action-button buy-button" data-item-id="${item.id}">–ö—É–ø–∏—Ç—å (${PART_PRICE} üåü)</button>
                    `;
                    const buyButton = div.querySelector('.buy-button');
                    buyButton.disabled = gameData.experience < PART_PRICE;
                    buyButton.onclick = (event) => {
                        event.stopPropagation();
                        buyPart(item.id);
                    };
                    div.querySelector('.list-item-main').onclick = () => showPartDetails(item.id, 'shop');
                    buyableItemsList.appendChild(div);
                });
            }
        }

        function renderMarketItems() {
            const rareParts = ALL_CODE_PARTS.filter(part =>
                part.rarity && part.rarity !== 'common' &&
                !gameData.collection.some(item => item.id === part.id) // Only show if not already collected
            );

            if (rareParts.length === 0) {
                marketItemsList.innerHTML = '<p style="text-align: center; width: 100%; color: var(--light-text-color);">–ù–∞ —Ä—ã–Ω–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–¥–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π, –∏–ª–∏ –≤—ã —É–∂–µ —Å–æ–±—Ä–∞–ª–∏ –∏—Ö –≤—Å–µ!</p>';
            } else {
                marketItemsList.innerHTML = '';
                const sortedRareParts = [...rareParts].sort((a, b) => a.name.localeCompare(b.name));

                sortedRareParts.forEach(item => {
                    const rarityInfo = RARITIES[item.rarity] || { price: 1, chance: 0, name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è' };
                    const marketPrice = rarityInfo.price;

                    const div = document.createElement('div');
                    div.className = 'list-item market-item'; // Add market-item class for specific styling
                    div.innerHTML = `
                        <div class="list-item-main">
                            <span class="list-item-name">${item.emoji || '‚ùì'} ${item.name}</span>
                            <span class="list-item-description">–†–µ–¥–∫–æ—Å—Ç—å: ${rarityInfo.name}</span>
                        </div>
                        <button class="item-action-button market-buy-button" data-item-id="${item.id}">–ö—É–ø–∏—Ç—å (${marketPrice} üåü)</button>
                    `;
                    const buyButton = div.querySelector('.market-buy-button');
                    buyButton.disabled = gameData.experience < marketPrice;
                    buyButton.onclick = (event) => {
                        event.stopPropagation();
                        buyPartFromMarket(item.id, marketPrice);
                    };
                    div.querySelector('.list-item-main').onclick = () => showPartDetails(item.id, 'market');
                    marketItemsList.appendChild(div);
                });
            }
        }

        function renderAchievements() {
            achievementsList.innerHTML = '';
            const allAchievements = Object.values(gameData.achievements);
            const sortedAchievements = allAchievements.sort((a, b) => {
                if (a.completed === b.completed) {
                    return a.name.localeCompare(b.name);
                }
                return a.completed ? 1 : -1; // Completed go to the end
            });

            sortedAchievements.forEach(ach => {
                const isCompleted = ach.completed;
                const div = document.createElement('div');
                div.className = `achievement-item ${isCompleted ? 'completed' : ''}`;
                div.innerHTML = `
                    <div>
                        <strong>${ach.name || '–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è'}</strong><br>
                        <span>${ach.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.'}</span>
                    </div>
                    ${isCompleted ? '<span>&#10003; –ü–æ–ª—É—á–µ–Ω–æ!</span>' : ''}
                `;
                achievementsList.appendChild(div);
            });
            if (allAchievements.length === 0) {
                 achievementsList.innerHTML = '<p style="text-align: center; width: 100%; color: var(--light-text-color);">–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø—É—Å—Ç.</p>';
            }
        }

        function renderStats() {
            statsUniqueCount.textContent = gameData.collection.length;
            const totalParts = gameData.collection.reduce((sum, item) => sum + item.count, 0);
            statsTotalCount.textContent = totalParts;
            statsExperienceEarned.textContent = gameData.totalXpEarned;
            statsPartsSold.textContent = gameData.partsSold;
            statsPartsBought.textContent = gameData.partsBought;
        }

        function renderProjects() {
            projectList.innerHTML = '';
            const incompleteProjects = gameData.projects.filter(p => !p.completed);
            const completedProjects = gameData.projects.filter(p => p.completed);

            // Sort incomplete projects by reward_xp or some other metric
            incompleteProjects.sort((a, b) => a.reward_xp - b.reward_xp);

            [...incompleteProjects, ...completedProjects].forEach(project => { // Incomplete first, then completed
                const div = document.createElement('div');
                div.className = `project-item ${project.completed ? 'completed' : ''}`;

                let requirementsHtml = '<ul>';
                let allRequirementsMet = true;
                project.requirements.forEach(reqId => {
                    const requiredPart = ALL_CODE_PARTS.find(p => p.id === reqId);
                    const hasPart = gameData.collection.some(item => item.id === reqId && item.count > 0);
                    const metClass = hasPart ? 'requirement-met' : '';
                    if (!hasPart) allRequirementsMet = false;
                    requirementsHtml += `<li class="${metClass}">${(requiredPart && requiredPart.emoji) || '‚ùì'} ${requiredPart ? requiredPart.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è'} ${hasPart ? '&#10003;' : '&#10007;'}</li>`;
                });
                requirementsHtml += '</ul>';

                div.innerHTML = `
                    <h4>${project.name || '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞'}</h4>
                    <p>${project.description || '–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.'}</p>
                    <p><strong>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</strong></p>
                    ${requirementsHtml}
                    <p><strong>–ù–∞–≥—Ä–∞–¥–∞:</strong> ${project.reward_xp} üåü</p>
                    ${project.completed ? '<p style="color: var(--primary-color); font-weight: bold;">–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!</p>' :
                    `<button class="project-action-button secondary-button" data-project-id="${project.id}" ${!allRequirementsMet ? 'disabled' : ''}>–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>`}
                `;

                if (!project.completed) {
                    const completeButton = div.querySelector('.project-action-button');
                    if (completeButton) {
                        completeButton.onclick = () => completeProject(project.id);
                    }
                }
                projectList.appendChild(div);
            });

            if (gameData.projects.length === 0) {
                 projectList.innerHTML = '<p style="text-align: center; width: 100%; color: var(--light-text-color);">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.</p>';
            } else if (incompleteProjects.length === 0 && completedProjects.length > 0) {
                 projectList.innerHTML += '<p style="text-align: center; width: 100%; color: var(--light-text-color); margin-top: 20px;">–í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã! –ñ–¥–∏—Ç–µ –Ω–æ–≤—ã—Ö!</p>';
            }
        }

        function renderBoosters() {
            boosterList.innerHTML = '';
            if (BOOSTERS.length === 0) {
                 boosterList.innerHTML = '<p style="text-align: center; width: 100%; color: var(--light-text-color);">–°–ø–∏—Å–æ–∫ –±—É—Å—Ç–µ—Ä–æ–≤ –ø—É—Å—Ç.</p>';
                 return;
            }
            BOOSTERS.forEach(booster => {
                const div = document.createElement('div');
                div.className = 'booster-item';
                const isActive = gameData.activeBoosters.some(b => b.id === booster.id && b.endsAt > Date.now());
                const currentBooster = gameData.activeBoosters.find(b => b.id === booster.id);

                div.innerHTML = `
                    <div>
                        <strong>${booster.name || '–ù–∞–∑–≤–∞–Ω–∏–µ –±—É—Å—Ç–µ—Ä–∞'}</strong><br>
                        <span>${booster.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.'}</span><br>
                        ${isActive ? `<span style="color:var(--primary-color); font-weight: bold;">–ê–∫—Ç–∏–≤–µ–Ω! –û—Å—Ç–∞–ª–æ—Å—å: ${formatTime(currentBooster.endsAt - Date.now())}</span>` : ''}
                    </div>
                    <button data-booster-id="${booster.id}" ${gameData.experience < booster.cost || isActive ? 'disabled' : ''}>–ö—É–ø–∏—Ç—å (${booster.cost} üåü)</button>
                `;
                const buyButton = div.querySelector('button');
                if (buyButton) {
                    buyButton.onclick = () => buyBooster(booster.id);
                }
                boosterList.appendChild(div);
            });
        }

        function renderHistory() {
            if (gameData.history.length === 0) {
                historyLog.innerHTML = '<p style="text-align: center; width: 100%; color: var(--light-text-color);">–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø—É—Å—Ç–∞.</p>';
            } else {
                historyLog.innerHTML = '';
                const recentHistory = gameData.history.slice(-20).reverse(); // Show last 20 entries
                recentHistory.forEach(entry => {
                    const date = new Date(entry.timestamp);
                    const timeString = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                    const div = document.createElement('div');
                    div.className = 'history-entry';
                    div.textContent = `[${timeString}] ${entry.message}`;
                    historyLog.appendChild(div);
                });
            }
        }


        // --- –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã ---
        function addExperience(amount) {
            let actualAmount = amount;
            const xpBooster = gameData.activeBoosters.find(b => b.id === 'xp_boost' && b.endsAt > Date.now());
            if (xpBooster) {
                actualAmount *= xpBooster.effect.value;
                // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –∑–¥–µ—Å—å –≤ gameData.message, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
            }

            gameData.experience += actualAmount;
            gameData.currentXp += actualAmount;
            gameData.totalXpEarned += actualAmount;

            checkLevelUp();
            checkAchievements();
            // addHistoryEntry(`–ü–æ–ª—É—á–µ–Ω–æ ${actualAmount} –æ–ø—ã—Ç–∞.`); // Avoid double logging if message already includes
        }

        function checkLevelUp() {
            while (gameData.currentXp >= gameData.xpToNextLevel) {
                gameData.currentXp -= gameData.xpToNextLevel;
                gameData.level++;
                gameData.xpToNextLevel = Math.floor(XP_PER_LEVEL_BASE * Math.pow(XP_PER_LEVEL_MULTIPLIER, gameData.level - 1));
                gameData.maxEnergy++; // –ü—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —É—Ä–æ–≤–Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é
                gameData.energy = gameData.maxEnergy; // –ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ –ø—Ä–∏ —É—Ä–æ–≤–Ω–µ
                gameData.message = `–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –£—Ä–æ–≤–Ω—è ${gameData.level}! üéâ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è —É–≤–µ–ª–∏—á–µ–Ω–∞ –¥–æ ${gameData.maxEnergy}!`;
                addHistoryEntry(`–£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω –¥–æ ${gameData.level}!`);
            }
        }

        function checkAchievements() {
            const uniquePartsCount = gameData.collection.length;
            const completedProjectsCount = gameData.projects.filter(p => p.completed).length;

            for (const achId in gameData.achievements) {
                const ach = gameData.achievements[achId];
                if (!ach.completed) {
                    let meetsCondition = false;
                    switch (achId) {
                        case 'collect_5_unique':
                        case 'collect_10_unique':
                        case 'collect_20_unique':
                            const requiredUnique = parseInt(achId.match(/\d+/)?.[0]); // Extract number from ID, use optional chaining
                            if (uniquePartsCount >= requiredUnique) meetsCondition = true;
                            break;
                        case 'collect_all_unique':
                            if (uniquePartsCount >= ALL_CODE_PARTS.length) meetsCondition = true;
                            break;
                        case 'earn_50_xp':
                        case 'earn_200_xp':
                            const requiredXp = parseInt(achId.match(/\d+/)?.[0]);
                            if (gameData.totalXpEarned >= requiredXp) meetsCondition = true;
                            break;
                        case 'sell_5_parts':
                            if (gameData.partsSold >= 5) meetsCondition = true;
                            break;
                        case 'buy_5_parts':
                            if (gameData.partsBought >= 5) meetsCondition = true;
                            break;
                        case 'complete_1_project':
                        case 'complete_3_projects':
                            const requiredProjects = parseInt(achId.match(/\d+/)?.[0]);
                            if (completedProjectsCount >= requiredProjects) meetsCondition = true;
                            break;
                    }

                    if (meetsCondition) {
                        ach.completed = true;
                        addExperience(ach.reward); // Achievement reward also affected by XP booster
                        gameData.message = `–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ "${ach.name}" –ø–æ–ª—É—á–µ–Ω–æ! (+${ach.reward} üåü)`;
                        addHistoryEntry(`–ü–æ–ª—É—á–µ–Ω–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: "${ach.name}"`);
                    }
                }
            }
        }


        // –õ–æ–≥–∏–∫–∞ –ø–æ–∫—É–ø–∫–∏ –≤ –æ–±—ã—á–Ω–æ–º –º–∞–≥–∞–∑–∏–Ω–µ
        function buyPart(partId) {
            if (gameData.experience < PART_PRICE) {
                gameData.message = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–ø—ã—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏! üö´';
                updateUI();
                return;
            }

            const partToBuy = ALL_CODE_PARTS.find(part => part.id === partId);
            if (!partToBuy) {
                gameData.message = '–û—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.';
                updateUI();
                return;
            }

            const existingPart = gameData.collection.find(item => item.id === partId);

            if (!existingPart) {
                gameData.collection.push({...partToBuy, count: 1});
            } else {
                existingPart.count++;
            }

            gameData.experience -= PART_PRICE;
            gameData.partsBought++;
            gameData.message = `–í—ã –∫—É–ø–∏–ª–∏ ${partToBuy.emoji || '‚ùì'} ${partToBuy.name}! (-${PART_PRICE} üåü)`;
            addHistoryEntry(`–ö—É–ø–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è: ${partToBuy.name}`);
            checkAchievements();
            updateUI();
        }

        // –õ–æ–≥–∏–∫–∞ –ø–æ–∫—É–ø–∫–∏ –Ω–∞ —Ä—ã–Ω–∫–µ —Ä–µ–¥–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
        function buyPartFromMarket(partId, price) {
            if (gameData.experience < price) {
                gameData.message = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–ø—ã—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏! üö´';
                updateUI();
                return;
            }

            const partToBuy = ALL_CODE_PARTS.find(part => part.id === partId);
            if (!partToBuy) {
                gameData.message = '–û—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.';
                updateUI();
                return;
            }

            const existingPart = gameData.collection.find(item => item.id === partId);
            if (existingPart) {
                 gameData.message = `${partToBuy.emoji || '‚ùì'} ${partToBuy.name} —É–∂–µ –µ—Å—Ç—å –≤ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏!`;
                 updateUI();
                 return;
            }

            gameData.collection.push({...partToBuy, count: 1});
            gameData.experience -= price;
            gameData.partsBought++;
            gameData.message = `–í—ã –∫—É–ø–∏–ª–∏ —Ä–µ–¥–∫—É—é —Ñ—É–Ω–∫—Ü–∏—é ${partToBuy.emoji || '‚ùì'} ${partToBuy.name} –Ω–∞ —Ä—ã–Ω–∫–µ! (-${price} üåü)`;
            addHistoryEntry(`–ö—É–ø–ª–µ–Ω–∞ —Ä–µ–¥–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è: ${partToBuy.name} –∑–∞ ${price} üåü`);
            checkAchievements();
            updateUI();
        }

        // –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–∞–∂–∏
        function sellPart(partId) {
            const existingPartIndex = gameData.collection.findIndex(item => item.id === partId);

            if (existingPartIndex !== -1) {
                const existingPart = gameData.collection[existingPartIndex];
                if (existingPart.count > 1) {
                    existingPart.count--;
                    gameData.message = `–í—ã –ø—Ä–æ–¥–∞–ª–∏ ${existingPart.emoji || '‚ùì'} ${existingPart.name}! –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –∏—Ö ${existingPart.count}. (+${PART_PRICE} üåü)`;
                } else {
                    gameData.collection.splice(existingPartIndex, 1);
                    gameData.message = `–í—ã –ø—Ä–æ–¥–∞–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é ${existingPart.emoji || '‚ùì'} ${existingPart.name}! (+${PART_PRICE} üåü)`;
                }
                gameData.experience += PART_PRICE;
                gameData.partsSold++;
                addHistoryEntry(`–ü—Ä–æ–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è: ${existingPart.name}`);
                checkAchievements();
            } else {
                gameData.message = '–û—à–∏–±–∫–∞: —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ—Ç –≤ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏.';
            }
            updateUI();
        }

        // --- –≠–Ω–µ—Ä–≥–∏—è ---
        function updateEnergy() {
            const now = Date.now();
            const timeElapsed = now - gameData.lastEnergyRecovery;
            const energyToRecover = Math.floor(timeElapsed / ENERGY_RECOVERY_INTERVAL_MS) * gameData.energyRecoveryRate;

            if (energyToRecover > 0) {
                gameData.energy = Math.min(gameData.maxEnergy, gameData.energy + energyToRecover);
                // –û–±–Ω–æ–≤–ª—è–µ–º lastEnergyRecovery —Ç–æ–ª—å–∫–æ –Ω–∞ —Ü–µ–ª–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç, —á—Ç–æ–±—ã –æ—Å—Ç–∞—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª—Å—è
                gameData.lastEnergyRecovery += (energyToRecover / gameData.energyRecoveryRate) * ENERGY_RECOVERY_INTERVAL_MS;
            }
        }

        // --- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å ---
        function checkDailyBonusAvailability() {
            const now = Date.now();
            if (now - gameData.lastDailyBonusClaim >= DAILY_BONUS_COOLDOWN_MS) {
                dailyBonusMessage.textContent = `–í–∞—à –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å –≥–æ—Ç–æ–≤! –ü–æ–ª—É—á–∏—Ç–µ ${DAILY_BONUS_AMOUNT} –æ–ø—ã—Ç–∞.`;
                claimDailyBonusButton.disabled = false;
            } else {
                const timeLeftMs = DAILY_BONUS_COOLDOWN_MS - (now - gameData.lastDailyBonusClaim);
                dailyBonusMessage.textContent = `–°–ª–µ–¥—É—é—â–∏–π –±–æ–Ω—É—Å —á–µ—Ä–µ–∑: ${formatTime(timeLeftMs)}`;
                claimDailyBonusButton.disabled = true;
            }
        }

        function claimDailyBonus() {
            const now = Date.now();
            if (now - gameData.lastDailyBonusClaim >= DAILY_BONUS_COOLDOWN_MS) {
                addExperience(DAILY_BONUS_AMOUNT);
                gameData.lastDailyBonusClaim = now;
                gameData.message = `–í—ã –ø–æ–ª—É—á–∏–ª–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å! (+${DAILY_BONUS_AMOUNT} üåü)`;
                addHistoryEntry(`–ü–æ–ª—É—á–µ–Ω –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å: +${DAILY_BONUS_AMOUNT} üåü`);
                updateUI();
            } else {
                gameData.message = '–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.';
                updateUI();
            }
        }

        // --- –ü—Ä–æ–µ–∫—Ç—ã ---
        function completeProject(projectId) {
            const project = gameData.projects.find(p => p.id === projectId);
            if (!project || project.completed) {
                gameData.message = '–û—à–∏–±–∫–∞: –ø—Ä–æ–µ–∫—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω.';
                updateUI();
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            const allRequirementsMet = project.requirements.every(reqId =>
                gameData.collection.some(item => item.id === reqId && item.count > 0)
            );

            if (allRequirementsMet) {
                project.completed = true;
                addExperience(project.reward_xp);
                gameData.message = `–ü—Ä–æ–µ–∫—Ç "${project.name}" –∑–∞–≤–µ—Ä—à–µ–Ω! –ù–∞–≥—Ä–∞–¥–∞: ${project.reward_xp} üåü!`;
                addHistoryEntry(`–ó–∞–≤–µ—Ä—à–µ–Ω –ø—Ä–æ–µ–∫—Ç: "${project.name}"`);
                checkAchievements();
                updateUI();
            } else {
                gameData.message = '–£ –≤–∞—Å –Ω–µ—Ç –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.';
                updateUI();
            }
        }

        // --- –ë—É—Å—Ç–µ—Ä—ã ---
        function buyBooster(boosterId) {
            const booster = BOOSTERS.find(b => b.id === boosterId);
            if (!booster) return;

            if (gameData.experience < booster.cost) {
                gameData.message = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–ø—ã—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –±—É—Å—Ç–µ—Ä–∞! üö´';
                updateUI();
                return;
            }

            if (booster.duration && gameData.activeBoosters.some(b => b.id === boosterId && b.endsAt > Date.now())) {
                 gameData.message = `${booster.name} —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω!`;
                 updateUI();
                 return;
            }
            if (!booster.duration && booster.effect.type === 'energy_refill' && gameData.energy === gameData.maxEnergy) {
                 gameData.message = '–≠–Ω–µ—Ä–≥–∏—è —É–∂–µ –ø–æ–ª–Ω–∞—è, –±—É—Å—Ç–µ—Ä –Ω–µ –Ω—É–∂–µ–Ω!';
                 updateUI();
                 return;
            }

            gameData.experience -= booster.cost;
            gameData.message = `–í—ã –∫—É–ø–∏–ª–∏ "${booster.name}"! (-${booster.cost} üåü)`;
            addHistoryEntry(`–ö—É–ø–ª–µ–Ω –±—É—Å—Ç–µ—Ä: "${booster.name}" –∑–∞ ${booster.cost} üåü`);


            if (booster.effect.type === 'xp_multiplier' || booster.effect.type === 'rare_chance') {
                gameData.activeBoosters.push({
                    id: booster.id,
                    endsAt: Date.now() + booster.duration,
                    effect: booster.effect
                });
                gameData.message += ` –ê–∫—Ç–∏–≤–µ–Ω ${formatTime(booster.duration)}!`;
            } else if (booster.effect.type === 'energy_refill') {
                gameData.energy = Math.min(gameData.maxEnergy, gameData.energy + booster.effect.value);
                gameData.message += ` –≠–Ω–µ—Ä–≥–∏—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ ${booster.effect.value} ‚ö°Ô∏è!`;
            }
            updateUI();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∏—Å—Ç–µ–∫—à–∏—Ö –±—É—Å—Ç–µ—Ä–æ–≤
        function cleanExpiredBoosters() {
            gameData.activeBoosters = gameData.activeBoosters.filter(b => b.endsAt > Date.now());
        }

        // --- –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π ---
        function addHistoryEntry(text) {
            gameData.history.push({ timestamp: Date.now(), message: text });
            if (gameData.history.length > 50) {
                gameData.history = gameData.history.slice(gameData.history.length - 50);
            }
        }


        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            if (hours > 0) return `${hours}—á ${minutes}–º`;
            if (minutes > 0) return `${minutes}–º ${seconds}—Å`;
            return `${seconds}—Å`;
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫–Ω–æ–ø–æ–∫ ---
        collectButton.addEventListener('click', () => {
            if (gameData.energy < ENERGY_CONSUMPTION_PER_FIND) {
                gameData.message = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞! üò¥';
                updateUI();
                return;
            }

            gameData.energy -= ENERGY_CONSUMPTION_PER_FIND;
            addHistoryEntry(`–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${ENERGY_CONSUMPTION_PER_FIND} —ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞.`);

            let foundPart = null;
            const rareChanceBooster = gameData.activeBoosters.find(b => b.id === 'find_chance_boost' && b.endsAt > Date.now());
            let currentRareChanceModifier = rareChanceBooster ? rareChanceBooster.effect.value : 0;

            // Generate weighted parts list for random selection based on rarity
            const weightedParts = [];
            ALL_CODE_PARTS.forEach(part => {
                const rarityDef = RARITIES[part.rarity] || RARITIES.common;
                let baseChance = rarityDef.chance;

                // Apply rare chance booster only to non-common parts
                if (part.rarity && part.rarity !== 'common') {
                    baseChance = Math.min(1.0, baseChance + currentRareChanceModifier);
                }

                // Add part to weighted list based on its chance (higher chance = more entries)
                // Multiply by a factor (e.g., 1000) to ensure enough resolution for chances
                for (let i = 0; i < Math.round(baseChance * 1000); i++) {
                    weightedParts.push(part);
                }
            });

            // Ensure there's always something to pick, even if all chances are very low
            if (weightedParts.length === 0 && ALL_CODE_PARTS.length > 0) {
                // Fallback: if somehow weighted list is empty, pick a random common part
                const commonParts = ALL_CODE_PARTS.filter(p => p.rarity === 'common');
                foundPart = commonParts.length > 0 ? commonParts[Math.floor(Math.random() * commonParts.length)] : ALL_CODE_PARTS[0];
            } else if (weightedParts.length > 0) {
                foundPart = weightedParts[Math.floor(Math.random() * weightedParts.length)];
            } else {
                 // Really shouldn't happen if ALL_CODE_PARTS is not empty
                 foundPart = { id: 'default_error', name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è', emoji: '‚ùì' };
            }


            const existingPart = gameData.collection.find(item => item.id === foundPart.id);

            if (!existingPart) {
                gameData.collection.push({...foundPart, count: 1});
                addExperience(1);
                gameData.message = `–í—ã –Ω–∞—à–ª–∏ –Ω–æ–≤—É—é SQL-—Ñ—É–Ω–∫—Ü–∏—é! üéâ ${foundPart.emoji || '‚ùì'} ${foundPart.name} (+1 üåü)`;
                addHistoryEntry(`–ù–∞–π–¥–µ–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: ${foundPart.name}`);
            }
            else {
                existingPart.count++;
                addExperience(1);
                gameData.message = `–í—ã –Ω–∞—à–ª–∏ ${foundPart.emoji || '‚ùì'} ${foundPart.name} (—É–∂–µ –µ—Å—Ç—å)! –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –∏—Ö ${existingPart.count}. (+1 üåü)`;
                addHistoryEntry(`–ù–∞–π–¥–µ–Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏: ${foundPart.name} (x${existingPart.count})`);
            }
            updateUI();
        });


        // –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∞
        function setGameView(view) {
            gameData.currentView = view;
            updateUI();
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫ –∫–Ω–æ–ø–∫–∞–º
        // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –æ–¥–∏–Ω —Ä–∞–∑, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π
        const setupEventListeners = () => {
            collectButton.addEventListener('click', () => setGameView('main'));
            viewCollectionButton.addEventListener('click', () => setGameView('collection'));
            createButton.addEventListener('click', () => setGameView('create'));
            shopButton.addEventListener('click', () => setGameView('shop'));
            dailyBonusButton.addEventListener('click', () => setGameView('daily_bonus'));
            achievementsButton.addEventListener('click', () => setGameView('achievements'));
            statsButton.addEventListener('click', () => setGameView('stats'));
            projectBoardButton.addEventListener('click', () => setGameView('projects'));
            boostersButton.addEventListener('click', () => setGameView('boosters'));
            marketButton.addEventListener('click', () => setGameView('market'));
            historyButton.addEventListener('click', () => setGameView('history'));

            backFromCollectionButton.addEventListener('click', () => setGameView('main'));
            backFromCreateButton.addEventListener('click', () => setGameView('main'));
            backFromShopButton.addEventListener('click', () => setGameView('main'));
            backFromMarketButton.addEventListener('click', () => setGameView('main'));
            backFromDailyBonusButton.addEventListener('click', () => setGameView('main'));
            backFromAchievementsButton.addEventListener('click', () => setGameView('main'));
            backFromStatsButton.addEventListener('click', () => setGameView('main'));
            backFromProjectBoardButton.addEventListener('click', () => setGameView('main'));
            backFromBoostersButton.addEventListener('click', () => setGameView('main'));
            backFromHistoryButton.addEventListener('click', () => setGameView('main'));

            claimDailyBonusButton.addEventListener('click', claimDailyBonus);

            resetGameButton.addEventListener('click', () => {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
                    localStorage.removeItem('coderGameData');
                    // Reset gameData to initial state directly
                    gameData = {
                        message: "–ò–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞ –∑–∞–Ω–æ–≤–æ! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üöÄ",
                        collection: [],
                        experience: 0,
                        level: 1,
                        xpToNextLevel: 100,
                        currentXp: 0,
                        totalXpEarned: 0,
                        partsSold: 0,
                        partsBought: 0,
                        lastDailyBonusClaim: 0,
                        energy: 10,
                        maxEnergy: 10,
                        energyRecoveryRate: 1,
                        lastEnergyRecovery: Date.now(),
                        activeBoosters: [],
                        history: [],
                        achievements: { // Re-initialize achievements
                            collect_5_unique: { completed: false, reward: 10, name: '–ü–µ—Ä–≤–æ–æ—Ç–∫—Ä—ã–≤–∞—Ç–µ–ª—å', description: '–°–æ–±—Ä–∞—Ç—å 5 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö SQL-—Ñ—É–Ω–∫—Ü–∏–π' },
                            collect_10_unique: { completed: false, reward: 20, name: '–Æ–Ω—ã–π –ë–∞–∑–∏—Å—Ç', description: '–°–æ–±—Ä–∞—Ç—å 10 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö SQL-—Ñ—É–Ω–∫—Ü–∏–π' },
                            collect_20_unique: { completed: false, reward: 40, name: '–ú–∞—Å—Ç–µ—Ä –ó–∞–ø—Ä–æ—Å–æ–≤', description: '–°–æ–±—Ä–∞—Ç—å 20 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö SQL-—Ñ—É–Ω–∫—Ü–∏–π' },
                            collect_all_unique: { completed: false, reward: 100, name: '–í–µ–ª–∏–∫–∏–π –°–±–æ—Ä—â–∏–∫', description: '–°–æ–±—Ä–∞—Ç—å –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ SQL-—Ñ—É–Ω–∫—Ü–∏–∏' },
                            earn_50_xp: { completed: false, reward: 15, name: '–û–ø—ã—Ç–Ω—ã–π –ö–æ–¥–µ—Ä', description: '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å 50 –æ–ø—ã—Ç–∞' },
                            earn_200_xp: { completed: false, reward: 50, name: '–ì—É—Ä—É SQL', description: '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å 200 –æ–ø—ã—Ç–∞' },
                            sell_5_parts: { completed: false, reward: 10, name: '–¢–æ—Ä–≥–æ–≤–µ—Ü –î–∞–Ω–Ω—ã–º–∏', description: '–ü—Ä–æ–¥–∞—Ç—å 5 SQL-—Ñ—É–Ω–∫—Ü–∏–π' },
                            buy_5_parts: { completed: false, reward: 10, name: '–û–ø—ã—Ç–Ω—ã–π –ü–æ–∫—É–ø–∞—Ç–µ–ª—å', description: '–ö—É–ø–∏—Ç—å 5 SQL-—Ñ—É–Ω–∫—Ü–∏–π' },
                            complete_1_project: { completed: false, reward: 25, name: '–ü–µ—Ä–≤—ã–π –ü—Ä–æ–µ–∫—Ç', description: '–ó–∞–≤–µ—Ä—à–∏—Ç—å 1 –ø—Ä–æ–µ–∫—Ç' },
                            complete_3_projects: { completed: false, reward: 50, name: '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ë–∞–∑ –î–∞–Ω–Ω—ã—Ö', description: '–ó–∞–≤–µ—Ä—à–∏—Ç—å 3 –ø—Ä–æ–µ–∫—Ç–∞' },
                        },
                        projects: [ // Re-initialize projects
                            { id: 'proj_basic_select', name: '–ë–∞–∑–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö', description: '–ò–∑–≤–ª–µ—á—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Customers.', requirements: ['sql_select', 'sql_from'], completed: false, reward_xp: 20 },
                            { id: 'proj_filtered_select', name: '–í—ã–±–æ—Ä–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º', description: '–ù–∞–π—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–æ—Ä–æ–∂–µ 50.', requirements: ['sql_select', 'sql_from', 'sql_where'], completed: false, reward_xp: 35 },
                            { id: 'proj_insert_data', name: '–í—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏', description: '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—É.', requirements: ['sql_insert_into', 'sql_values'], completed: false, reward_xp: 25 },
                            { id: 'proj_update_record', name: '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏', description: '–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏.', requirements: ['sql_update', 'sql_set', 'sql_where'], completed: false, reward_xp: 30 },
                            { id: 'proj_delete_record', name: '–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏', description: '–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã.', requirements: ['sql_delete_from', 'sql_where'], completed: false, reward_xp: 20 },
                            { id: 'proj_table_join', name: '–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü', description: '–°–æ–µ–¥–∏–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Customers –∏ Orders.', requirements: ['sql_select', 'sql_from', 'sql_join'], completed: false, reward_xp: 50 },
                            { id: 'proj_create_simple_table', name: '–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–π —Ç–∞–±–ª–∏—Ü—ã', description: '–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å ID –∏ –∏–º–µ–Ω–µ–º.', requirements: ['sql_create_table', 'sql_int', 'sql_varchar'], completed: false, reward_xp: 40 },
                            { id: 'proj_count_records', name: '–ü–æ–¥—Å—á–µ—Ç –∑–∞–ø–∏—Å–µ–π', description: '–ü–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ.', requirements: ['sql_select', 'sql_count', 'sql_from'], completed: false, reward_xp: 20 },
                            { id: 'proj_aggregate_data', name: '–í—ã—á–∏—Å–ª–∏—Ç—å —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.', requirements: ['sql_select', 'sql_avg', 'sql_group_by'], completed: false, reward_xp: 45 }
                        ],
                        currentView: 'main'
                    };
                    updateUI();
                    // For Telegram WebApp, consider forcing a full reload or even closing to ensure state reset
                    if (window.Telegram && window.Telegram.WebApp) {
                        // Telegram.WebApp.close(); // Or simply reload
                        window.location.reload();
                    } else {
                        location.reload();
                    }
                }
            });
        };

        // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã ---
        function saveGameData() {
            localStorage.setItem('coderGameData', JSON.stringify(gameData));
            // console.log('Game data saved!');
        }

        function loadGameData() {
            const savedData = localStorage.getItem('coderGameData');
            if (savedData) {
                const loadedGameData = JSON.parse(savedData);

                // Load basic game properties, providing defaults for new fields (e.g., totalXpEarned, history)
                gameData.experience = loadedGameData.experience ?? 0;
                gameData.level = loadedGameData.level ?? 1;
                gameData.xpToNextLevel = loadedGameData.xpToNextLevel ?? 100;
                gameData.currentXp = loadedGameData.currentXp ?? 0;
                gameData.totalXpEarned = loadedGameData.totalXpEarned ?? 0;
                gameData.partsSold = loadedGameData.partsSold ?? 0;
                gameData.partsBought = loadedGameData.partsBought ?? 0;
                gameData.lastDailyBonusClaim = loadedGameData.lastDailyBonusClaim ?? 0;
                gameData.energy = loadedGameData.energy ?? 10;
                gameData.maxEnergy = loadedGameData.maxEnergy ?? 10;
                gameData.energyRecoveryRate = loadedGameData.energyRecoveryRate ?? 1;
                gameData.lastEnergyRecovery = loadedGameData.lastEnergyRecovery ?? Date.now();
                gameData.currentView = loadedGameData.currentView ?? 'main';
                gameData.message = loadedGameData.message ?? "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ!";


                // Load and clean active boosters
                gameData.activeBoosters = (loadedGameData.activeBoosters || []).filter(b => b.endsAt > Date.now());

                // Load history
                gameData.history = loadedGameData.history || [];

                // Load achievements: only copy the 'completed' status, keep current definitions
                for (const achId in gameData.achievements) {
                    if (loadedGameData.achievements && loadedGameData.achievements[achId]) {
                        gameData.achievements[achId].completed = loadedGameData.achievements[achId].completed;
                    }
                }

                // Load projects: similar to achievements, update 'completed' status, keep current definitions
                const loadedProjectsMap = new Map((loadedGameData.projects || []).map(p => [p.id, p]));
                gameData.projects = gameData.projects.map(defaultProj => {
                    if (loadedProjectsMap.has(defaultProj.id)) {
                        return { ...defaultProj, completed: loadedProjectsMap.get(defaultProj.id).completed };
                    }
                    return defaultProj; // New project, not found in save, stays as is (uncompleted)
                });

                // Load collection: ensure parts exist in ALL_CODE_PARTS and have a count property
                gameData.collection = (loadedGameData.collection || []).map(item => {
                    const fullItem = ALL_CODE_PARTS.find(part => part.id === item.id);
                    return fullItem ? { ...fullItem, count: item.count || 1 } : null;
                }).filter(Boolean); // Filter out null values if old IDs are not found
            }
        }


        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners(); // Setup listeners once on DOMContentLoaded
            loadGameData();
            updateEnergy(); // Check energy immediately after loading
            cleanExpiredBoosters(); // Clean expired boosters
            updateUI(); // Update UI after loading data

            // Set initial message only if it was not changed during loading
            if (gameData.currentView === 'main' && gameData.message === "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!") {
                 gameMessageElement.textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ! –£ –≤–∞—Å ${gameData.experience} üåü`;
            }
        });


        // Auto-save every 5 seconds
        setInterval(saveGameData, 5000);

        // Update energy and boosters every second for smooth timer display
        setInterval(() => {
            updateEnergy();
            cleanExpiredBoosters();
            // Only update UI if we are on a relevant panel that shows time
            if (gameData.currentView === 'daily_bonus' || gameData.currentView === 'boosters') {
                 updateUI();
            }
        }, 1000);
    </script>
</body>
</html>
